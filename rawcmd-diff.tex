% DIFF macro
\def\DIFFEND{}
\def\DIFFNEW#1\DIFFEND{}
\def\DIFFOLDXX#1\DIFFEND{%
        \setbox11=\hbox{#1}%
        \hbox to0pt{%
              \vbox to0pt{%
              \vss
              \special{color push rgb 1 0 0}%
              \vrule height10pt width\wd11\relax
              \special{color pop}}%
              \hss}%
              #1}

\def\redsquare{\llap{\special{color push rgb 1 .6 .6}\vrule width1pc height1pc\special{color pop}}}
\def\textmarker{\hbox to0pt{\hskip-\h_reg sp\vbox to0pt{\vskip-9pt\redsquare}}}%
\def\DIFFOLD{%
        \textmarker%
        %\let\save_currfont\currfont
        \edef\naext{\noexpand\font\noexpand\redfont=red-\csname font-\number\current_font-def\endcsname\noexpand\redfont}
        \naext}
\def\DIFFEND{\currfont}
%
\def\DIFFEND{\special{color pop}}
\def\DIFFNEW{\special{color push rgb 0 0 1 }}
\def\DIFFOLD{\special{color push rgb 1 0 0 }}
%
\def\colorblue{\special{color push rgb 0 0 1 }}
\def\colorred{\special{color push rgb 1 0 0 }}
\def\colorgreen{\special{color push rgb 1 1 0 }}
\def\colorpop{\special{color pop}}
\long\def\DELETEOLD#1\DELETEEND{\colorred#1\colorpop}
\long\def\INSERTOLD#1\INSERTEND{\colorblue#1\colorpop}
\long\def\DELETENEW#1\DELETEEND{}
\long\def\INSERTNEW#1\INSERTEND{\colorblue#1\colorpop}


\long\def\DELETEOLDred#1\DELETEENDred{#1}%\colorred#1\colorpop}
\long\def\INSERTOLDred#1\INSERTENDred{\colorred#1\colorpop}
\long\def\DELETENEWred#1\DELETEENDred{#1}
\long\def\INSERTNEWred#1\INSERTENDred{\colorred#1\colorpop}
\long\def\DIFFOLDred#1\DIFFENDred{\colorred#1\colorpop}

\def\@firstofone#1{#1}
\def\@empty{}
\def\@@gobble#1{}
\def\noharm%
{%
  \let\text\@firstofone
  \let\x\@@gobble
  \let\w\@@gobble
  \let\right\@@gobble
  \let\wzero\@empty
  \let\xzero\@empty
}
\long\def\REDOLD#1\ENDREDOLD%
{%
  \begingroup
    \noharm
    \xdef\@xold{#1}%
  \endgroup
  }
\def\printred#1{\colorred#1\colorpop}
\long\def\REDNEW#1\ENDREDNEW%
{%
  \begingroup%
    \noharm%
    \xdef\@xnew{#1}%
  \endgroup%
  \ifx\@xnew\@xold\relax
    #1
  \else
    \printred{#1}%
  \fi
}